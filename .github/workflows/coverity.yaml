name: Coverity Scan
on: workflow_dispatch
permissions:
  contents: read

jobs:
  coverity:
    name: Coverity Scan
    runs-on: ubuntu-latest
    env:
      COVURL: scan.coverity.com
      OWNER: paulhuggett
      REPOSITORY: AM_MIDI2.0Lib
      BUILD_TOOL_DIR: "${{ github.workspace }}/coverity-build"

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: audit

      - name: Checkout Sources
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Get the Coverity Build Tool MD5
        id: get-cov-md5
        env:
          SECRET: ${{ secrets.COVERITY_TOKEN }}
        run: |
          mkdir -p "${{ env.BUILD_TOOL_DIR }}"
          PROJECT="${{ env.OWNER }}/${{ env.REPOSITORY }}"
          curl                                                     \
            --data-urlencode "md5=1"                               \
            --data-urlencode project="${PROJECT}"                  \
            --data-urlencode token="${SECRET}"                     \
            --location                                             \
            --output "${{ env.BUILD_TOOL_DIR }}/coverity_tool.md5" \
            "https://${{ env.COVURL }}/download/linux64"
          MD5=$(cat "${{ env.BUILD_TOOL_DIR }}/coverity_tool.md5")
          echo "Coverity Tool MD5: $MD5"
          echo "md5=$MD5" >> "$GITHUB_OUTPUT"

      - name: Cache the Coverity Build Tool
        id: cache-build-tool
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
        with:
          key: coverity-${{ runner.os }}-${{ steps.get-cov-md5.outputs.md5 }}
          path: "${{ env.BUILD_TOOL_DIR }}/coverity_tool.tgz"

      - name: Download the Coverity Build Tool
        if: ${{ steps.cache-build-tool.outputs.cache-hit != 'true' }}
        env:
          SECRET: ${{ secrets.COVERITY_TOKEN }}
        run: |
          echo ${{ steps.cache-build-tool.outputs.cache-hit }}
          mkdir -p "${{ env.BUILD_TOOL_DIR }}"
          PROJECT="${{ env.OWNER }}/${{ env.REPOSITORY }}"
          curl                                                     \
            --data-urlencode project="${PROJECT}"                  \
            --data-urlencode token="${SECRET}"                     \
            --location                                             \
            --output "${{ env.BUILD_TOOL_DIR }}/coverity_tool.tgz" \
            "https://${{ env.COVURL }}/download/linux64"

      - name: Unpack the Coverity Build Tool
        run: |
          cd "${{ env.BUILD_TOOL_DIR }}"
          ls -l coverity_tool.tgz
          tar xzf coverity_tool.tgz
          ls

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake

      - name: Configure
        run: |
          rm -f -r ./build
          cmake                         \
            -S .                        \
            -B ./build                  \
            -D CMAKE_BUILD_TYPE=Release \
            -D MIDI2_UNITTEST=False     \
            -D MIDI2_DEMO=True

      - name: Build
        run: |
          $(find "${{ env.BUILD_TOOL_DIR }}" -name cov-build) \
            --dir cov-int                                     \
            cmake --build ./build --config Release
          tail cov-int/build-log.txt

      - name: Compress Results
        run: |
          tar czvf ./results.tgz cov-int

      - name: Submit Results
        env:
          TOKEN: ${{ secrets.COVERITY_TOKEN }}
          EMAIL: ${{ secrets.COVERITY_EMAIL }}
        run: |
          VERSION=$(git rev-parse --short HEAD)
          PROJECT="${{ env.OWNER }}%2f${{ env.REPOSITORY }}"
          curl                                    \
            --form token="${TOKEN}"               \
            --form email="${EMAIL}"               \
            --form file=@./results.tgz            \
            --form version="${VERSION}"           \
            --form description="MIDI 2.0 library" \
            "https://${{ env.COVURL }}/builds?project=$PROJECT"
